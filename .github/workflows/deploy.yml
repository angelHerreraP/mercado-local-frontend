name: Deploy Frontend

on:
  push:
    branches: [ "main" ]

env:
  AWS_REGION: us-east-1
  S3_BUCKET: mercadolocal-mx-frontend-bucket

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install Dependencies
      run: npm ci

    - name: Inject API URL
      run: |
        # Get ALB DNS Name
        ALB_DNS=$(aws elbv2 describe-load-balancers --names "mercadolocal-mx-alb" --query "LoadBalancers[0].DNSName" --output text)
        if [ "$ALB_DNS" == "None" ] || [ -z "$ALB_DNS" ]; then
           echo "Warning: ALB not found, using placeholder"
           ALB_DNS="placeholder-api-url"
        fi
        
        echo "Injecting API URL: http://$ALB_DNS/api"
        
        # Replace placeholder in environment.prod.ts
        sed -i "s|PLACEHOLDER_API_URL|http://$ALB_DNS/api|g" src/environments/environment.prod.ts

    - name: Build Angular App
      run: npm run build

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Sync to S3
      run: |
        aws s3 sync ./dist/front-end/browser s3://${{ env.S3_BUCKET }} --delete

    - name: Invalidate CloudFront Cache
      run: |
        DISTRIBUTION_ID=$(aws cloudfront list-distributions --query "DistributionList.Items[?Comment=='mercadolocal-mx-cf'].Id" --output text)
        if [ -n "$DISTRIBUTION_ID" ]; then
          aws cloudfront create-invalidation --distribution-id $DISTRIBUTION_ID --paths "/*"
        fi
